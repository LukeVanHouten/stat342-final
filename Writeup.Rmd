---
title: "Placebo-Controlled Efficacy Analysis of the COVID-19 Vaccine"
author: "Oliver Brown, Josie Czeskleba, Luke VanHouten"
subtitle: "Spring 2024"
header-includes:
    - \usepackage{amsmath}
    - \usepackage{amsthm}
bibliography: refs.bib
nocite: '@*'
fontsize: 11pt
output: pdf_document
---

```{r setup, include=FALSE}
#Use this code chunk to include libraries, and set global options.
knitr::opts_chunk$set(warning = FALSE)
library(tidyverse)
library(maxLik)
library(reshape2)
library(fastR2)
```

# Abstract

# Keywords

Efficacy, Likelihood, COVID-19, Bootstrap, Estimators

# Introduction

<<<<<<< HEAD
The Coronavirus disease (COVID-19) affected millions worldwide. It was imperative to global health that a safe and effective vaccine was developed. In a late 2020, multinational, placebo-controlled, observer-blinded, pivotal efficacy study observers randomly assigned people ages 16 and older in a 1:1 ratio to receive two doses, of either placebo or the BNT162b2 vaccine.  The primary efficacy endpoint was the time of laboratory-confirmed COVID-19. The FDA requires at least 30% efficacy for a new vaccine to be approved. We will apply multiple statistical methods to test the hypothesis: the BNT162B2 vaccine has 95% efficacy. 

=======
The Coronavirus disease (COVID-19) affected millions worldwide. It was imperative to global health that a safe and effective vaccine was developed. In late 2020, a multinational, placebo-controlled, observer-blinded study for the efficacy of the Pfizer-BioNTech BNT16b2 COVID-19 mRNA vaccine was conducted where people ages 16 and older in a 1:1 gender ratio were given two doses of either a placebo or the BNT162b2 vaccine. The efficacy of the vaccine is extremely important, because the goal of vaccination efforts are to save lives. The FDA requires at least  30% efficacy for a new vaccine to be approved, but a much higher percentage is desirable. If the vaccine is not sufficiently effective, than the work put into to developing it would be inefficient, and that work should then be focused on the development of a different vaccine. If the vaccine is sufficiently effective, we can recommend that it be widely used. Our hypothesis is that the BNT162B2 vaccine efficacy is 95%, which we will test using different statistical methods discussed, based on another research effort using Bayesian methods [@COVIDpaper].
>>>>>>> b27e4fe544496c833c90c722abe3ac32d9f9907d

# Statistical Methods

We denote the random variable $T$ as the number of vaccinated individuals from the 170 COVID cases.

\[ T \sim Binom(n = 170,\pi) \]

We can define $\pi = \textrm{P(Vaccine|COVID)} = \frac{\pi_1}{\pi_1 + \pi_2}$, given that the sample sizes for the vaccine and placebo groups are approximately equal. Here, $\pi_1$ is the proportion of vaccinated individuals who got COVID and $\pi_2$ is the proportion of unvaccinated individuals who got COVID. Moreover, we define the vaccine efficacy as $\psi = \frac{1-2\pi}{1-\pi}$ [@errorstatistics]. We can then formulate the following hypothesis test:

\[ H_0: \psi_0 = 0.95 \]
\[ H_1: \psi_0 \neq 0.95 \]

## Maximum Likelihood Estimator

We can first write the likelihood function of $\pi$

\[ L(\pi) = \binom{n}{t}\pi^t(1 - \pi)^{n - t} \]

Then we write $\pi$ in the form $\pi = g(\psi)$, given that $\psi = \frac{1 - 2\pi}{1 - \pi}$. We thus have that $\psi - \psi\pi = 1 - 2\pi$, which becomes $2\pi - \psi\pi = 1 - \psi$, which becomes:

\[ \pi = \frac{1 - \psi}{2 - \psi} \]

We can then write the likelihood function for $\psi$:

\[ L(\psi) = L(g(\psi)) = L\left(\frac{1 - \psi}{2 - \psi}\right) = \binom{n}{t}\left(\frac{1 - \psi}{2 - \psi}\right)^t\left(1 - \left(\frac{1-\psi}{2-\psi}\right)\right)^{n - t} = \binom{n}{t}\left(\frac{1 - \psi}{2 - \psi}\right)^t\left(\frac{1}{2 - \psi}\right)^{n - t} \]

We can then calculate the log-likelihood function for $\psi$:

\[ \ell(\psi) = \ln(L(\psi) = \ln\left(\binom{n}{t}\right) + t\ln(1 - \psi) - t\ln(2 - \psi) - (n - t)\ln(2 - \psi) = \ln\left(\binom{n}{t}\right) + t\ln(1 - \psi) - n\ln(2 - \psi) \]

We can then find our estimator by setting $\ell'(\psi) = 0$:

\[ \frac{d}{d\psi} \ell(\psi) = \frac{d}{d\psi} \ln\left(\binom{n}{t}\right) + \frac{d}{d\psi} t\ln(1 - \psi) - \frac{d}{d\psi} n\ln(2 - \psi) = \frac{n}{2 - \psi} - \frac{t}{1 - \psi} = 0 \]

We can then solve $\frac{n}{2 - \psi} = \frac{t}{1 - \psi}$. We get that $n - n\psi = 2t - t\psi$, which becomes $t\psi - n\psi = 2t - n$, giving us an estimator of $\widehat{\psi}^{mle}_0 = \frac{2t - n}{t - n}$. We can use our MLE to perform a likelihood ratio test, defined as $W = 2\left(\ell\left(\hat{\psi}^{mle}_0\right) - \ell\left(\psi^{null}_0\right)\right)$, which we can write as:

\[ W = 2\left(\left(\ln\left(\binom{n}{t}\right) + t\ln\left(1 - \widehat{\psi}^{mle}_0\right) - n\ln\left(2 - \widehat{\psi}^{mle}_0\right)\right) - \left(\ln\left(\binom{n}{t}\right) + t\ln\left(1 - \psi^{null}_0\right) - n\ln\left(2 - \psi^{null}_0\right)\right)\right) \]

This becomes:

\[ W = 2t\ln\left(1 - \widehat{\psi}^{mle}_0\right) - 2n\ln\left(2 - \widehat{\psi}^{mle}_0\right) - 2t\ln\left(1 - \psi^{null}_0\right) + 2n\ln\left(2 - \psi^{null}_0\right) \]

## Bootstrap

The bootstrap approach involves repeatedly resampling the observed data with replacement to create numerous simulated datasets. For each simulated dataset, we compute the proportions of COVID-19 cases in both groups, and subsequently, the efficacy parameter $\psi$. This process provides a distribution of the efficacy estimates from which we can derive confidence intervals. 

Step-wise we begin by creating two subsets of the data: one for the vaccine group and one for the placebo group. This step ensures that we can accurately calculate the number of subjects and the proportions of COVID-19 cases within each group.

Once the proportions are calculated, we compute the observed efficacy parameter $\pi$ and subsequently $\psi$. The parameter $\pi$ is defined as the proportion of COVID-19 cases in the vaccine group divided by the sum of the proportions in both the vaccine and placebo groups. The efficacy parameter $\psi$ is then calculated using the formula $\psi = \frac{1 - 2\pi}{1 - \pi}$. These parameters provide a basis for comparing the vaccine's efficacy against COVID-19.

To assess the variability of the efficacy estimate, we perform a bootstrap simulation with 10,000 iterations. In each iteration, resample the data with replacement to generate new datasets for both the vaccine and placebo groups. For each bootstrap sample, we recalculate the proportions of COVID-19 cases and subsequently the efficacy parameter $\psi$. This process generates a distribution of $\psi$ values, which can be used to estimate the confidence interval.

We calculate the 95% confidence interval for the efficacy parameter $\psi$ using the quantiles of the bootstrap distribution. This interval provides a range within which the true efficacy is likely to lie, based on the variability observed in the bootstrap samples.

# Results

For our MLE, we can plug in $t_{obs} = 8$ and $n = 170$ to $\widehat{\psi}^{mle}_0 = \frac{2t - n}{t - n}$, we get $\widehat{\psi}^{mle}_0 = \frac{16 - 170}{8 - 170} = \frac{77}{81} = `r round(77 / 81, 4)`$. We can also use the Newton Raphson method to estimate $\psi$ to get the same value, shown in the appendix.

For the likelihood ratio test, we can plug in our values $\widehat{\psi}^{mle}_0 = `r round(77 / 81, 4)`$, $\psi^{null}_0 = 0.95$, $t = 8$, and $n = 170$ to our W to get:

\[ W = 2(8)\ln\left(1 - `r round(77 / 81, 4)`\right) - 2(170)\ln\left(2 - `r round(77 / 81, 4)`\right) - 2(8)\ln\left(1 - 0.95\right) + 2(170)\ln\left(2 - 0.95\right) = 0.0012 \]

Our sample size is large enough to where $W \sim \chi^2_1$, so we can calculate P-value for our hypothesis as $P(W \geq 0.0012) = 0.9726$. This P-value is very large, so we fail to reject the null hypothesis under our likelihood ratio test that the COVID-19 vaccine efficacy is 95%.

For our bootstrap, the analysis was performed with $10000$ iterations to ensure a stable estimate of the vaccine efficacy. The observed efficacy, calculated from the original data, was consistent with the findings of Polack et al. (2020). The histogram of the bootstrap $\psi$ values revealed a right-skewed distribution, indicating that most of the bootstrap samples support a high efficacy of the vaccine. The $95\%$ confidence interval for $\psi$ derived from the bootstrap distribution, ranged from $0.91$ to $0.98$, closely aligning with the Bayesian credible interval reported in the original study.

(Histogram)

(Segmented line graph)

# Conclusion

# References

<div id="refs"></div>

# Appendix

## Newton Rhapson MLE Approximation

```{r}
loglik <- function(psi, T, n){
  if (psi > 1 | psi < 0) 
    return(NA)
  else
    return(log(choose(n, T)) + (T * log(1 - psi)) - (n * log(2 - psi)))
}

estimation <- maxLik2(loglik = loglik, start = 0.55, method = "NR", tol = 1e-4, 
                      T = 8, n = 170)

print(estimation)

```

## Likelihood Ratio Test Calculation

```{r}
W = (2 * 8 * log(1 - (77 / 81))) - (2 * 170 * log(2 - (77 / 81))) -
    (2 * 8 * log(1 - 0.95)) + (2 * 170 * log(2 - 0.95))

p_value <- round(pchisq(q = W, df = 1, lower.tail=F), 4)
```

Here, $W$ is `r round(W, 4)` and the corresponding P-value is `r p_value`.

## Bootstrap

```{r}
data <- read.csv("data.csv")

vaccine <- data %>%
  filter(Test == "Vaccine")

placebo <- data %>%
  filter(Test == "Placebo")

n_vaccine <- vaccine$COVID + vaccine$No_COVID
n_placebo <- placebo$COVID + placebo$No_COVID

prop_vaccine <- vaccine$COVID[1] / n_vaccine
prop_placebo <- placebo$COVID[1] / n_placebo

observed_pi <- prop_vaccine/(prop_vaccine + prop_placebo)

observed_psi <- (1 - 2*observed_pi)/(1 - observed_pi)
```

```{r}

n_bootstrap <- 10000
bootstrap_psis <- numeric(n_bootstrap)
set.seed(123)

for (i in 1:n_bootstrap) {
  vaccine_sample <- sample(c(0, 1), size = n_vaccine, replace = TRUE, 
                           prob = c(1 - prop_vaccine, prop_vaccine))
  placebo_sample <- sample(c(0, 1), size = n_placebo, replace = TRUE, 
                           prob = c(1 - prop_placebo, prop_placebo))
  
  prop_vaccine_boot <- mean(vaccine_sample)
  prop_placebo_boot <- mean(placebo_sample)
  
  bootstrap_pi <- prop_vaccine_boot / (prop_vaccine_boot + prop_placebo_boot)
  
  bootstrap_psis[i] <- (1 - 2 * bootstrap_pi) / (1 - bootstrap_pi)
}
```

```{r}

bootstrap_df <- data.frame(psi = bootstrap_psis)

ggplot(bootstrap_df, aes(x = psi)) +
  geom_histogram(binwidth = 0.007, fill = "darkorchid1", color = "black") +
  labs(title = "Histogram of Bootstrap Psi Values", x = "Psi", y = "Frequency") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```



```{r}

overall_ci <- quantile(bootstrap_psis, c(0.025, 0.975))

ci_data <- data.frame(
  Iteration = 1:n_bootstrap,
  Lower = numeric(n_bootstrap),
  Upper = numeric(n_bootstrap)
)

for (i in 1:n_bootstrap) {
  sample_psis <- sample(bootstrap_psis, n_bootstrap, replace = TRUE)
  ci_data$Lower[i] <- quantile(sample_psis, 0.025)
  ci_data$Upper[i] <- quantile(sample_psis, 0.975)
}

print(overall_ci)


```

```{r}
plot_data <- ci_data[seq(1, n_bootstrap, by = 300), ]

ggplot(plot_data, aes(y = Iteration)) +
  geom_vline(xintercept = observed_psi, linetype = "solid", color = "red") + 
  geom_text(aes(x = observed_psi-0.0125, 
                y = max(Iteration) + 300, label = "Observed Psi"), 
            color = "red", hjust = -0.05) +
  geom_segment(aes(yend = Iteration, x = Lower, xend = Upper), color = "navy") +
  geom_vline(xintercept = overall_ci[1], linetype = "dashed", color = "red") +
  geom_vline(xintercept = overall_ci[2], linetype = "dashed", color = "red") +
  geom_text(aes(x = overall_ci[1] + 0.0129, 
                y = max(Iteration) + 300, label = "Lower Bound"), 
            color = "red", hjust = 1.1) +
  geom_text(aes(x = overall_ci[2] - 0.0129, y = max(Iteration) + 300, 
                label = "Upper Bound"), color = "red", hjust = -0.1) +
  labs(title = "Confidence Intervals of Bootstrap Samples",
       y = "Iteration",
       x = "Confidence Interval",
       subtitle = "Each line segment represents a 95% confidence interval for a bootstrap sample") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 10),
        axis.text.y = element_text(hjust = 1))
```

## Visualizations

```{r}
plot(estimation) +
    labs(title = "Second order approximation to the Log-Likelihood Function", 
         x = expression(psi))

data_melted <- melt(data, id.vars = "Test")

```

### Stacked Barplot

```{r stacked barplot, echo = TRUE}
ggplot(data_melted, aes(x = Test, y = value, fill = variable)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = value), 
            position = position_stack(vjust = 0.5)) +
  labs(x = "Test", y = "Number of Participants", 
       title = "COVID Infection for Placebo and Test Groups") 
```

