---
title: "Placebo-Controlled Efficacy Analysis of the COVID-19 Vaccine"
author: "Oliver Brown, Josie Czeskleba, Luke VanHouten"
subtitle: "Spring 2024"
header-includes:
    - \usepackage{amsmath}
    - \usepackage{amsthm}
    - \input{header.tex}
bibliography: refs.bib
nocite: '@*'
fontsize: 11pt
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE)
library(tidyverse)
library(maxLik)
library(reshape2)
library(fastR2)
```

# Abstract

# Keywords

Efficacy, Likelihood, COVID-19, Bootstrap, Estimators

# Introduction

The COVID-19 pandemic impacted millions globally, making a safe and effective vaccine crucial. In December 2020, Pfizer and BioNTech received FDA Emergency Use Authorization for their two-dose BNT162b2 COVID-19 mRNA vaccine. This placebo-controlled, observer-blinded study involved participants aged 16 and older, randomly assigned to receive either the placebo or the vaccine. The study measured efficacy by tracking COVID-19 cases, with a null hypothesis of 95% efficacy. Given the FDA's minimum efficacy requirement of 30%, this paper focuses on the statistical analysis of the vaccine's efficacy. Using methods from STAT 341-342, we will apply hypothesis testing, confidence intervals, and Bayesian methods to evaluate the data. The thoroughness of this analysis is essential for ensuring reliable and valid findings, which will guide public health decisions based on robust evidence.[@COVIDpaper].


# Statistical Methods

The data for positive and negative tests between the placebo and vaccine groups is taken from the previous research on the vaccine efficacy [@COVIDpaper]:

\begin{table}[h]
    \centering
    \begin{tabular}{c|p{1in}|p{1in}|p{1in}}
    Test & Positive & Negative & Total \\ \hline
    Vaccine & 8 & 17403 & 17411 \\ \hline
    Placebo & 162 & 17349 & 17511 \\ \hline
    Total & 170 & 34752 & 34922 \\ \hline
    \end{tabular}
\end{table}
        
We denote the random variable $T$ as the number of vaccinated individuals from the 170 COVID cases.

\[ T \sim Binom(n = 170,\pi) \]

We can define $\pi = \textrm{P(Vaccine|COVID)} = \frac{\pi_1}{\pi_1 + \pi_2}$, given that the sample sizes for the vaccine and placebo groups are approximately equal. Here, $\pi_1$ is the proportion of vaccinated individuals who got COVID and $\pi_2$ is the proportion of unvaccinated individuals who got COVID. Moreover, we define the vaccine efficacy as $\psi = \frac{1-2\pi}{1-\pi}$ [@errorstatistics]. We can then formulate the following hypothesis test:

\[ H_0: \psi_0 = 0.95 \]
\[ H_1: \psi_0 \neq 0.95 \]

We will use a maximum likelihood estimator to conduct a likelihood ratio test as well as bootstrapped confidence intervals to test our hypothesis.

## Maximum Likelihood Estimator

The first method we used to analyze the BNT162b2 vaccine efficacy is maximum likelihood estimation. We found the maximum likelihood estimate for our efficacy parameter $\psi$, which we can call $\hat{\psi}^{mle}_0$ given $t_{obs} = 8$ for our positive tests in the vaccine group. To calculate this estimator, we can first write the likelihood function of $\pi$ based on the PDF of $T$:

\[ L(\pi) = \binom{n}{t}\pi^t(1 - \pi)^{n - t} \]

Then we write $\pi$ in the form $\pi = g(\psi)$, given that $\psi = \frac{1 - 2\pi}{1 - \pi}$. We thus have that $\psi - \psi\pi = 1 - 2\pi$, which becomes $2\pi - \psi\pi = 1 - \psi$, which becomes:

\[ \pi = \frac{1 - \psi}{2 - \psi} \]

Because $\psi$ is the parameter we want to make our estimator,we can rewrite our likelihood function in terms of $\psi$, still based on the PDF of $T$ for $t_{obs} = 8$:

\[ L(\psi) = L(g(\psi)) = L\left(\frac{1 - \psi}{2 - \psi}\right) = \binom{n}{t}\left(\frac{1 - \psi}{2 - \psi}\right)^t\left(1 - \left(\frac{1-\psi}{2-\psi}\right)\right)^{n - t} = \binom{n}{t}\left(\frac{1 - \psi}{2 - \psi}\right)^t\left(\frac{1}{2 - \psi}\right)^{n - t} \]

Mathematically, it is difficult to do much with just this function, so we can log-transform it to convert it from a product to a sum. We can calculate the log-likelihood function for $\psi$ as shown here:

\[ \ell(\psi) = \ln(L(\psi) = \ln\left(\binom{n}{t}\right) + t\ln(1 - \psi) - t\ln(2 - \psi) - (n - t)\ln(2 - \psi) = \ln\left(\binom{n}{t}\right) + t\ln(1 - \psi) - n\ln(2 - \psi) \]

Our estimator is defined as where the log-likelihood function is maximized by the parameter $\psi$, and we can find this by computing $\underset{\psi}{\arg\max} \ \ell(\psi | t)$, or in other words, by taking the derivative of this function and setting it equal to 0. So we can calculate $\ell'(\psi) = 0$ here:

\[ \frac{d}{d\psi} \ell(\psi) = \frac{d}{d\psi} \ln\left(\binom{n}{t}\right) + \frac{d}{d\psi} t\ln(1 - \psi) - \frac{d}{d\psi} n\ln(2 - \psi) = \frac{n}{2 - \psi} - \frac{t}{1 - \psi} = 0 \]

We can then solve $\frac{n}{2 - \psi} = \frac{t}{1 - \psi}$. We get that $n - n\psi = 2t - t\psi$, which becomes $t\psi - n\psi = 2t - n$. Assuming that this critical point is a maximum, we have that our estimator estimator is $\widehat{\psi}^{mle}_0 = \frac{2t - n}{t - n}$. We cannot use the estimator on its own to make much inference about our hypothesis. However, e can use our MLE to perform a likelihood ratio test, defined as $W = 2\left(\ell\left(\hat{\psi}^{mle}_0\right) - \ell\left(\psi^{null}_0\right)\right)$. A small $W$ corresponds with statistical significance for rejecting the null hypothesis, and vice versa. For a sufficiently sized $n$, which we have as $n = 170$, the distribution $W \sim \chi^2_1$ holds, letting us compute a P-value for our hypothesis. We can compute this value of $W$ here as:

\[ W = 2\left(\left(\ln\left(\binom{n}{t}\right) + t\ln\left(1 - \widehat{\psi}^{mle}_0\right) - n\ln\left(2 - \widehat{\psi}^{mle}_0\right)\right) - \left(\ln\left(\binom{n}{t}\right) + t\ln\left(1 - \psi^{null}_0\right) - n\ln\left(2 - \psi^{null}_0\right)\right)\right) \]

This becomes:

\[ W = 2t\ln\left(1 - \widehat{\psi}^{mle}_0\right) - 2n\ln\left(2 - \widehat{\psi}^{mle}_0\right) - 2t\ln\left(1 - \psi^{null}_0\right) + 2n\ln\left(2 - \psi^{null}_0\right) \]

Finally, we can set up an equation to find a 95% confidence interval for our parameter $\psi$:

\[
\widehat{\psi}^{\text{mle}}_0 \pm 1.96 \sqrt{\frac{-1}{\ell''(\widehat{\psi}^{\text{mle}}_0)}} = \widehat{\psi}^{\text{mle}}_0 \pm 1.96 \sqrt{\frac{-1}{\frac{n}{(2 - \widehat{\psi}^{\text{mle}}_0)^2} - \frac{t}{(1 - \widehat{\psi}^{\text{mle}}_0)^2}}}
\]




# Results

For our MLE, we can plug in $t_{obs} = 8$ and $n = 170$ to $\widehat{\psi}^{mle}_0 = \frac{2t - n}{t - n}$, we get $\widehat{\psi}^{mle}_0 = \frac{16 - 170}{8 - 170} = \frac{77}{81} = `r round(77 / 81, 4)`$. We can also use the Newton Raphson method to estimate $\psi$ to get the same value, shown in the appendix.

For the likelihood ratio test, we can plug in our values $\widehat{\psi}^{mle}_0 = `r round(77 / 81, 4)`$, $\psi^{null}_0 = 0.95$, $t = 8$, and $n = 170$ to our W to get:

\[ W = 2(8)\ln\left(1 - `r round(77 / 81, 4)`\right) - 2(170)\ln\left(2 - `r round(77 / 81, 4)`\right) - 2(8)\ln\left(1 - 0.95\right) + 2(170)\ln\left(2 - 0.95\right) = 0.0012 \]

As stated prior, our sample size is large enough to where $W \sim \chi^2_1$, so we can calculate P-value for our hypothesis as $P(W \geq 0.0012) = 0.9726$. This P-value is very large, so we fail to reject the null hypothesis under our likelihood ratio test that the COVID-19 vaccine efficacy is 95%.

Finally, we can use our MLE estimator to calculate a 95% confidence interval for $\psi$:

\[ 0.9506 \pm 1.96\sqrt{\frac{-1}{-3124.317}} = 0.9506 \pm 0.0351\]

We are 95% confident that the true efficacy of the BNT162b2 vaccine lies in interval [91.55%, 98.57%]. These values far exceed the FDA required efficacy of 30%. 

For our bootstrap, the analysis was performed with $10000$ iterations to ensure a stable estimate of the vaccine efficacy. The observed efficacy, calculated from the original data, was consistent with the findings of Polack et al. (2020). The histogram of the bootstrap $\psi$ values revealed a right-skewed distribution, indicating that most of the bootstrap samples support a high efficacy of the vaccine. The $95\%$ confidence interval for $\psi$ derived from the bootstrap distribution, ranged from $0.91$ to $0.98$, closely aligning with the Bayesian credible interval reported in the original study.


# Conclusion

# References

<div id="refs"></div>

# Appendix

## Visualizations

```{r read data, echo = FALSE}
data <- read.csv("data.csv")
data_melted <- melt(data, id.vars = "Test")
```

### Stacked Barplot

```{r stacked barplot, echo = TRUE}
ggplot(data_melted, aes(x = Test, y = value, fill = variable)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = value), 
            position = position_stack(vjust = 0.5)) +
  labs(x = "Test", y = "Number of Participants", 
       title = "COVID Infection for Vaccine and Placebo Groups") 
```


## Newton Rhapson MLE Approximation

```{r newton rhapson, echo= TRUE}
loglik <- function(psi, T, n){
  if (psi > 1 | psi < 0) 
    return(NA)
  else
    return(log(choose(n, T)) + (T * log(1 - psi)) - (n * log(2 - psi)))
}

estimation <- maxLik2(loglik = loglik, start = 0.55, method = "NR", tol = 1e-4, 
                      T = 8, n = 170)

print(estimation)

plot(estimation) +
    labs(title = "Second order approximation to the Log-Likelihood Function", 
         x = expression(psi))
```

## Likelihood Ratio Test Calculation

```{r likelihood ratio test, echo = TRUE}
W = (2 * 8 * log(1 - (77 / 81))) - (2 * 170 * log(2 - (77 / 81))) -
    (2 * 8 * log(1 - 0.95)) + (2 * 170 * log(2 - 0.95))

p_value <- round(pchisq(q = W, df = 1, lower.tail=F), 4)
```

Here, $W$ is `r round(W, 4)` and the corresponding P-value is `r p_value`.

## MLE Confidence interval calculation
```{r mle confidence inteval, echo = TRUE}

se <- sqrt(-1/((170/(2-0.9506)^2) - (8/(1-0.9506)^2)))
upper_lim <- 0.9506 + 1.96*se
lower_lim <- 0.9506 - 1.96*se

```

The calculated confidence interval is [0.9155, 0.9856] with a standard error of `r round(se,4)`.

## Bootstrap

```{r obs psi, echo = TRUE}
vaccine <- data %>%
  filter(Test == "Vaccine")

placebo <- data %>%
  filter(Test == "Placebo")

n_vaccine <- vaccine$COVID + vaccine$No_COVID
n_placebo <- placebo$COVID + placebo$No_COVID

prop_vaccine <- vaccine$COVID[1] / n_vaccine
prop_placebo <- placebo$COVID[1] / n_placebo

observed_pi <- prop_vaccine/(prop_vaccine + prop_placebo)

observed_psi <- (1 - 2*observed_pi)/(1 - observed_pi)
```

```{r bootstrap, echo = TRUE}

n_bootstrap <- 10000
bootstrap_psis <- numeric(n_bootstrap)
set.seed(123)

for (i in 1:n_bootstrap) {
  vaccine_sample <- sample(c(0, 1), size = n_vaccine, replace = TRUE, 
                           prob = c(1 - prop_vaccine, prop_vaccine))
  placebo_sample <- sample(c(0, 1), size = n_placebo, replace = TRUE, 
                           prob = c(1 - prop_placebo, prop_placebo))
  
  prop_vaccine_boot <- mean(vaccine_sample)
  prop_placebo_boot <- mean(placebo_sample)
  
  bootstrap_pi <- prop_vaccine_boot / (prop_vaccine_boot + prop_placebo_boot)
  
  bootstrap_psis[i] <- (1 - 2 * bootstrap_pi) / (1 - bootstrap_pi)
}
```

```{r bootstrap plot, echo = TRUE}

bootstrap_df <- data.frame(psi = bootstrap_psis)

ggplot(bootstrap_df, aes(x = psi)) +
  geom_histogram(binwidth = 0.007, fill = "darkorchid1", color = "black") +
  labs(title = "Histogram of Bootstrap Psi Values", x = "Psi", y = "Frequency") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

```

```{r bootstrap CI, echo = TRUE}

overall_ci <- quantile(bootstrap_psis, c(0.025, 0.975))

ci_data <- data.frame(
  Iteration = 1:n_bootstrap,
  Lower = numeric(n_bootstrap),
  Upper = numeric(n_bootstrap)
)

for (i in 1:n_bootstrap) {
  sample_psis <- sample(bootstrap_psis, n_bootstrap, replace = TRUE)
  ci_data$Lower[i] <- quantile(sample_psis, 0.025)
  ci_data$Upper[i] <- quantile(sample_psis, 0.975)
}

print(overall_ci)

```

```{r bootstrap CI plot, echo = TRUE}
plot_data <- ci_data[seq(1, n_bootstrap, by = 300), ]

ggplot(plot_data, aes(y = Iteration)) +
  geom_vline(xintercept = observed_psi, linetype = "solid", color = "red") + 
  geom_text(aes(x = observed_psi-0.0125, 
                y = max(Iteration) + 300, label = "Observed Psi"), 
            color = "red", hjust = -0.05) +
  geom_segment(aes(yend = Iteration, x = Lower, xend = Upper), color = "navy") +
  geom_vline(xintercept = overall_ci[1], linetype = "dashed", color = "red") +
  geom_vline(xintercept = overall_ci[2], linetype = "dashed", color = "red") +
  geom_text(aes(x = overall_ci[1] + 0.0129, 
                y = max(Iteration) + 300, label = "Lower Bound"), 
            color = "red", hjust = 1.1) +
  geom_text(aes(x = overall_ci[2] - 0.0129, y = max(Iteration) + 300, 
                label = "Upper Bound"), color = "red", hjust = -0.1) +
  labs(title = "Confidence Intervals of Bootstrap Samples",
       y = "Iteration",
       x = "Confidence Interval",
       subtitle = "Each line segment represents a 95% confidence interval for a bootstrap sample") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 10),
        axis.text.y = element_text(hjust = 1))
```

