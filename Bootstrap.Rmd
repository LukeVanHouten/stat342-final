---
title: "Bootstrap"
output: pdf_document
date: "2024-05-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 8, fig.height = 6)

library(boot)
library(readr)
library(tidyverse)

```

```{r}

data <- read_csv("data.csv", show_col_types = F)

colnames(data)[colnames(data) == 'No_COVID'] <- 'n'

```

```{r}

vaccine <- data %>%
  filter(Test == "Vaccine")

placebo <- data %>%
  filter(Test == "Placebo")

prop_vaccine <- vaccine$COVID / vaccine$n
prop_placebo <- placebo$COVID / placebo$n

observed_pi <- prop_vaccine/(prop_vaccine + prop_placebo)

observed_psi <- (1 - 2*observed_pi)/(1 - observed_pi)

```


```{r}

n_bootstrap <- 10000
bootstrap_psis <- numeric(n_bootstrap)
set.seed(123)

for (i in 1:n_bootstrap) {
  vaccine_sample <- sample(c(0, 1), size = vaccine$n, replace = TRUE, prob = c(1 - prop_vaccine, prop_vaccine))
  placebo_sample <- sample(c(0, 1), size = placebo$n, replace = TRUE, prob = c(1 - prop_placebo, prop_placebo))
  
  prop_vaccine_boot <- mean(vaccine_sample)
  prop_placebo_boot <- mean(placebo_sample)
  
  bootstrap_pi <- prop_vaccine_boot / (prop_vaccine_boot + prop_placebo_boot)
  
  bootstrap_psis[i] <- (1 - 2 * bootstrap_pi) / (1 - bootstrap_pi)
}

```

```{r}

bootstrap_df <- data.frame(psi = bootstrap_psis)

ggplot(bootstrap_df, aes(x = psi)) +
  geom_histogram(binwidth = 0.007, fill = "mediumpurple", color = "black") +
  labs(title = "Histogram of Bootstrap Psi Values", x = "Psi", y = "Frequency") +
  theme_minimal() +
  geom_vline(xintercept = observed_psi, linetype = "solid", color = "red") + 
  theme(plot.title = element_text(hjust = 0.5))

```



```{r}

bootstrap_summary <- bootstrap_df %>%
  summarise(n = n(), 
            mean = mean(psi), 
            sd = sd(psi), 
            lower_critical_value = mean - qnorm(0.975)*sd, 
            upper_critical_value =  mean + qnorm(0.975)*sd)

lower_critical_value <- bootstrap_summary$lower_critical_value
upper_critical_value <- bootstrap_summary$upper_critical_value

bootstrap_summary

```

```{r}

ci_data <- data.frame(
  Iteration = 1:n_bootstrap,
  Lower = numeric(n_bootstrap),
  Upper = numeric(n_bootstrap)
)

for (i in 1:n_bootstrap) {
  sample_psis <- sample(bootstrap_psis, n_bootstrap, replace = TRUE)
  ci_data$Lower[i] <- mean(sample_psis) - qnorm(0.975)*sd(sample_psis)
  ci_data$Upper[i] <- mean(sample_psis) + qnorm(0.975)*sd(sample_psis)
}

```


```{r}

plot_data <- ci_data[seq(1, n_bootstrap, by = 200), ]

ggplot(plot_data, aes(y = Iteration)) +
  geom_vline(xintercept = observed_psi, linetype = "solid", color = "blue") + 
  geom_text(aes(x = observed_psi, y = max(Iteration) + 300, label = "Observed Psi"), color = "blue", hjust = -0.05) +
  geom_vline(xintercept = bootstrap_summary$mean, linetype = "dashed", color = "red") + 
  geom_text(aes(x = bootstrap_summary$mean - 0.012, y = max(Iteration) + 300, label = "Estimated Psi"), color = "red", hjust = -0.05) +
  geom_segment(aes(yend = Iteration, x = Lower, xend = Upper), color = "navy") +
  geom_vline(xintercept = lower_critical_value, linetype = "dashed", color = "red") +
  geom_vline(xintercept = upper_critical_value, linetype = "dashed", color = "red") +
  geom_text(aes(x = lower_critical_value + 0.0129, y = max(Iteration) + 300, label = "Lower Bound"), color = "red", hjust = 1.1) +
  geom_text(aes(x = upper_critical_value - 0.0129, y = max(Iteration) + 300, label = "Upper Bound"), color = "red", hjust = -0.1) +
  labs(title = "Confidence Intervals of Bootstrap Samples",
       y = "Iteration",
       x = "Confidence Interval",
       subtitle = "Each line segment represents a 95% confidence interval for a bootstrap sample") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, size = 10),
        axis.text.y = element_text(hjust = 1))
```

$H_0: \psi = 0.95$

$H_1:\psi \not = 0.95$

The null hypothesis $H_0$ posits that the observed vaccine efficacy is consistent with the bootstrap distribution, implying no significant deviation from what would be expected if the vaccine efficacy were accurately captured by the bootstrap samples. The alternative hypothesis $H_1$ suggests that the observed efficacy is significantly different, indicating potential issues with the efficacy estimate.

```{r}

p_greater_than <- length(bootstrap_psis[bootstrap_psis >= observed_psi])/length(bootstrap_psis)
p_lower_than <- length(bootstrap_psis[bootstrap_psis <= observed_psi])/length(bootstrap_psis)

p_value <- 2 * min(percent_greater_than, percent_lower_than)
print(p_value)

2*pnorm(observed_psi, mean = bootstrap_summary$mean, sd = bootstrap_summary$sd, lower.tail = F)

```

Given the empirical p-value of 0.9704, we do not find sufficient evidence to reject the null hypothesis. This high p-value indicates that the observed efficacy $\psi=0.95$ is consistent with the bootstrap distribution, suggesting that the efficacy is not significantly different from the expected distribution. Thus, our analysis supports the conclusion that the observed vaccine efficacy is reliable and within the expected range, reaffirming the findings reported by Pfizer and BioNTech.

